<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Kingdom MMO — World Map</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="common.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    .topbar{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);background:#0b0f14;}
    .topbar .spacer{flex:1;}
    .tab{padding:6px 10px;border:1px solid var(--border);border-radius:8px;text-decoration:none;color:var(--text);background:#0c151b;}
    .map-shell{padding:12px;}
    .map-card{border:1px solid var(--border);background:#0c1117;border-radius:10px;padding:12px;}
    .map-head{display:flex;align-items:center;gap:12px;margin-bottom:10px;flex-wrap:wrap;}
    .map-wrap{position:relative;width:100%;display:grid;grid-template-columns:1fr 320px;gap:12px;}
    .map-canvas-wrap{position:relative;display:flex;align-items:flex-start;overflow:auto;max-height:calc(100vh - 180px);}
    canvas#world{image-rendering:pixelated;border:1px solid var(--border);background:#0a0f14;}
    .map-side{border:1px solid var(--border);background:#0a1218;border-radius:10px;padding:10px;height:fit-content;}
    .legend{font-size:12px;color:#9db0c0;display:flex;gap:10px;flex-wrap:wrap;}
    .legend span{display:inline-flex;align-items:center;gap:6px;}
    .swatch{width:10px;height:10px;border-radius:2px;display:inline-block;}
    .info-line{margin:2px 0;font-size:14px;}
    .hint{color:#9db0c0;font-size:12px;margin-top:6px;}
    @media(max-width:900px){.map-wrap{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">KINGDOM // MUD</div>
    <div class="spacer"></div>
    <a class="tab" id="gameLink" href="index.html">Game</a>
    <div class="pill">alpha</div>
  </div>

  <div class="map-shell">
    <div class="map-card">
      <div class="map-head">
        <div class="title" style="text-transform:uppercase;letter-spacing:.6px;color:var(--muted);font-weight:700;">World Map</div>
        <button id="btnRefresh" class="button">Refresh</button>
        <button id="btnCenter" class="button">Center on Me</button>
        <div style="color:#9db0c0;font-size:13px">Scale</div>
        <select id="scaleSel">
          <option>2</option><option>3</option><option selected>4</option><option>6</option><option>8</option>
        </select>
        <div class="legend">
          <span><i class="swatch" style="background:#1e88e5"></i>Ocean</span>
          <span><i class="swatch" style="background:#66bb6a"></i>Plains</span>
          <span><i class="swatch" style="background:#388e3c"></i>Forest</span>
          <span><i class="swatch" style="background:#8d6e63"></i>Hills</span>
          <span><i class="swatch" style="background:#9e9e9e"></i>Mountain</span>
          <span><i class="swatch" style="background:#ffd54a"></i>Capital</span>
          <span><i class="swatch" style="background:#b388ff"></i>Town</span>
          <span><i class="swatch" style="background:#ff4d4d"></i>You</span>
        </div>
      </div>

      <div class="map-wrap">
        <div class="map-canvas-wrap" id="canvasWrap">
          <canvas id="world" width="768" height="768"></canvas>
        </div>
        <div class="map-side" id="info">
          <div style="font-weight:700;margin-bottom:6px;">Cell / Town Info</div>
          <div class="info-line" id="line-xy">Click on the map…</div>
          <div class="info-line" id="line-biome"></div>
          <div class="info-line" id="line-lq"></div>
          <hr style="border:none;border-top:1px solid var(--border);margin:8px 0;">
          <div class="info-line" id="line-town"></div>
          <div class="info-line" id="line-owner"></div>
          <div class="info-line" id="line-pop"></div>
          <div class="info-line minor" id="line-me"></div>
          <div style="margin-top:8px;">
            <button id="btnCopyCoords" class="btn-sm" title="Copy world coords">Copy Coords</button>
            <button id="btnCopyCmd" class="btn-sm" title="Context command">Copy Command</button>
          </div>
          <div class="hint" style="margin-top:10px;">Tip: Capital is bright yellow; founded towns are purple. Names are immutable.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------------------------------------
    // 🔒 Carry token + username across pages
    // ---------------------------------------------------------
    (function ensureIdentityCookies() {
      const t = localStorage.getItem("kmmoToken");
      const u = localStorage.getItem("mud_user");
      if (t) {
        document.cookie = `kmmoToken=${encodeURIComponent(t)}; path=/; max-age=31536000; SameSite=Lax`;
        console.log("[map] ✅ Token synced");
      } else {
        console.warn("[map] ⚠️ No token found. Please log in on the Game page first.");
        const warn=document.createElement("div");
        warn.style.cssText="padding:8px;margin:8px 0;background:#281818;color:#ffaaaa;font-weight:bold;";
        warn.textContent="⚠️ Not logged in. Go back to the Game page to start your session.";
        document.body.prepend(warn);
      }
      if (u) document.cookie=`mud_user=${encodeURIComponent(u)}; path=/; max-age=31536000; SameSite=Lax`;
    })();

    // ---------------------------------------------------------
    // Map rendering + player position
    // ---------------------------------------------------------
    const canvas=document.getElementById("world");
    const ctx=canvas.getContext("2d");
    const wrap=document.getElementById("canvasWrap");
    const scaleSel=document.getElementById("scaleSel");
    const btnRefresh=document.getElementById("btnRefresh");
    const btnCenter=document.getElementById("btnCenter");
    const btnCopyCoords=document.getElementById("btnCopyCoords");
    const btnCopyCmd=document.getElementById("btnCopyCmd");

    const lineXY=document.getElementById("line-xy");
    const lineBiome=document.getElementById("line-biome");
    const lineLQ=document.getElementById("line-lq");
    const lineTown=document.getElementById("line-town");
    const lineOwner=document.getElementById("line-owner");
    const linePop=document.getElementById("line-pop");
    const lineMe=document.getElementById("line-me");

    const C={ocean:"#1e88e5",coast:"#42a5f5",plains:"#66bb6a",forest:"#388e3c",hills:"#8d6e63",mountain:"#9e9e9e"};
    const CAP="#ffd54a",TOWN="#b388ff",YOU="#ff4d4d";

    let META=null,CELLS=[],TOWNS=[];
    const CELLMAP=new Map(),TOWNMAP=new Map();
    let cellSize=Number(scaleSel.value);
    let selected=null,myPos=null;
    const key=(x,y)=>`${x},${y}`;
    const colorFor=b=>C[b]||"#666";

    async function fetchGrid(){
      const r=await fetch("/api/world/grid");
      const j=await r.json();
      if(!j.ok||!j.meta){drawEmpty("World not generated yet.");return;}
      META=j.meta;CELLS=j.cells||[];TOWNS=j.towns||[];
      rebuildLookups();await fetchMyPos();draw();renderMeLine();
    }

    function rebuildLookups(){
      CELLMAP.clear();TOWNMAP.clear();
      for(const c of CELLS)CELLMAP.set(key(c.x,c.y),{biome:c.biome,lq:c.lq});
      for(const t of TOWNS)TOWNMAP.set(key(t.x,t.y),t);
    }

    async function fetchMyPos(){
      myPos=null;
      try{
        const u=localStorage.getItem("mud_user");
        if(!u)return;
        const r=await fetch(`/api/world/playerpos?u=${encodeURIComponent(u)}`);
        const j=await r.json();
        if(j.ok)myPos=j;
      }catch(e){console.error("[map] fetchMyPos error:",e);}
    }

    function drawEmpty(text){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle="#0a0f14";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle="#9db0c0";
      ctx.font="28px ui-monospace, monospace";
      ctx.fillText(text,20,50);
    }

    function draw(){
      if(!META)return;
      cellSize=Number(scaleSel.value);
      canvas.width=META.width*cellSize;
      canvas.height=META.height*cellSize;
      for(const c of CELLS){ctx.fillStyle=colorFor(c.biome);ctx.fillRect(c.x*cellSize,c.y*cellSize,cellSize,cellSize);}
      for(const t of TOWNS){
        const x=t.x*cellSize+Math.floor(cellSize/2);
        const y=t.y*cellSize+Math.floor(cellSize/2);
        ctx.strokeStyle="#000";ctx.lineWidth=Math.max(1,Math.floor(cellSize/3));
        ctx.beginPath();ctx.arc(x,y,Math.max(2,cellSize*0.45),0,Math.PI*2);ctx.stroke();
        ctx.fillStyle=t.is_capital?CAP:TOWN;ctx.beginPath();
        ctx.arc(x,y,Math.max(2,cellSize*0.35),0,Math.PI*2);ctx.fill();
      }
      if(myPos&&myPos.exists&&!myPos.isTown&&myPos.x!=null&&myPos.y!=null){
        const x=myPos.x*cellSize+Math.floor(cellSize/2);
        const y=myPos.y*cellSize+Math.floor(cellSize/2);
        ctx.strokeStyle="#000";ctx.lineWidth=Math.max(1,Math.floor(cellSize/3));
        ctx.beginPath();ctx.arc(x,y,Math.max(2,cellSize*0.5),0,Math.PI*2);ctx.stroke();
        ctx.fillStyle=YOU;ctx.beginPath();ctx.arc(x,y,Math.max(2,cellSize*0.4),0,Math.PI*2);ctx.fill();
      }
      if(cellSize>=6){
        ctx.font=`${Math.max(10,Math.floor(cellSize*1.5))}px ui-monospace, monospace`;
        ctx.textAlign="left";ctx.textBaseline="middle";
        for(const t of TOWNS){
          const x=t.x*cellSize+cellSize*0.6;const y=t.y*cellSize;
          ctx.fillStyle="rgba(0,0,0,0.7)";ctx.fillText(t.name,x+1,y+1);
          ctx.fillStyle=t.is_capital?CAP:TOWN;ctx.fillText(t.name,x,y);
        }
      }
      if(selected){
        ctx.strokeStyle="#fff";
        ctx.lineWidth=Math.max(1,Math.floor(cellSize/4));
        ctx.strokeRect(selected.x*cellSize+0.5,selected.y*cellSize+0.5,cellSize-1,cellSize-1);
      }
    }

    function renderMeLine(){
      if(!myPos||!myPos.exists){lineMe.textContent="";return;}
      if(myPos.isTown)lineMe.textContent=`You are in ${myPos.is_capital?"the Capital":"a town"} (${myPos.room}).`;
      else if(myPos.x!=null)lineMe.textContent=`You are here: (${myPos.x},${myPos.y}) — wilderness`;
      else lineMe.textContent=`Your current room is not mapped.`;
    }

    function centerOn(gx,gy){
      const tx=gx*cellSize+cellSize/2-wrap.clientWidth/2;
      const ty=gy*cellSize+cellSize/2-wrap.clientHeight/2;
      wrap.scrollTo({left:Math.max(0,tx),top:Math.max(0,ty),behavior:"smooth"});
    }

    canvas.addEventListener("click",e=>{
      if(!META)return;
      const r=canvas.getBoundingClientRect();
      const gx=Math.floor((e.clientX-r.left)/cellSize);
      const gy=Math.floor((e.clientY-r.top)/cellSize);
      if(gx<0||gy<0||gx>=META.width||gy>=META.height)return;
      selected={x:gx,y:gy};
      const c=CELLMAP.get(key(gx,gy)),t=TOWNMAP.get(key(gx,gy));
      lineXY.textContent=`Cell: (${gx}, ${gy})`;
      lineBiome.textContent=`Biome: ${c?c.biome:"?"}`;
      lineLQ.textContent=`Living Quality: ${c&&Number.isFinite(c.lq)?c.lq:"?"}`;
      if(t){
        lineTown.textContent=`${t.is_capital?"Capital":"Town"}: ${t.name}`;
        lineOwner.textContent=`Lord: ${t.owner??"—"}`;
        linePop.textContent=`Population: ${t.pop??0}`;
      }else{
        lineTown.textContent="";lineOwner.textContent="";linePop.textContent="";
      }
      draw();
    });

    btnRefresh.addEventListener("click",fetchGrid);
    scaleSel.addEventListener("change",draw);
    btnCenter.addEventListener("click",async()=>{
      await fetchMyPos();renderMeLine();draw();
      if(myPos&&myPos.x!=null&&myPos.y!=null)centerOn(myPos.x,myPos.y);
    });
    btnCopyCoords.addEventListener("click",()=>{
      if(!selected)return;
      navigator.clipboard.writeText(`${selected.x},${selected.y}`).catch(()=>{});
    });
    btnCopyCmd.addEventListener("click",()=>{
      if(!selected)return;
      const k=key(selected.x,selected.y);
      const town=TOWNMAP.get(k);
      const cmd=town?`/travel ${town.name}`:`/foundat ${selected.x} ${selected.y} <TownName>`;
      navigator.clipboard.writeText(cmd).catch(()=>{});
    });

    fetchGrid().catch(console.error);
  </script>
</body>
</html>
